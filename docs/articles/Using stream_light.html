<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Inform modern browsers that this page supports both dark and light color schemes,
  and the page author prefers light. --><meta name="color-scheme" content="dark light">
<script>
  // If `prefers-color-scheme` is not supported, fall back to light mode.
  // i.e. In this case, inject the `light` CSS before the others, with
  // no media filter so that it will be downloaded with highest priority.
  if (window.matchMedia("(prefers-color-scheme: dark)").media === "not all") {
    document.documentElement.style.display = "none";
    document.head.insertAdjacentHTML(
      "beforeend",
      "<link id=\"css\" rel=\"stylesheet\" href=\"https://bootswatch.com/3/flatly/bootstrap.css\" onload=\"document.documentElement.style.display = ''\">"
    );
  }
</script><title>3. Using stream_light • StreamLight</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- Flatly Theme - Light  --><link id="css-light" rel="stylesheet" href="https://bootswatch.com/3/flatly/bootstrap.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
<!-- Darkly Theme - Dark --><link id="css-dark" rel="stylesheet" href="https://bootswatch.com/3/darkly/bootstrap.css" media="(prefers-color-scheme: dark)">
<!-- preferably CSS --><link rel="stylesheet" href="../preferably.css">
<link id="css-code-light" rel="stylesheet" href="../code-color-scheme-light.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
<link id="css-code-dark" rel="stylesheet" href="../code-color-scheme-dark.css" media="(prefers-color-scheme: dark)">
<script src="../darkswitch.js"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="3. Using stream_light">
<meta property="og:description" content="StreamLight">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">StreamLight</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Download%20and%20process%20MODIS%20LAI.html">2. Download and process MODIS LAI</a>
    </li>
    <li>
      <a href="../articles/Download%20and%20process%20NLDAS.html">1. Download and process NLDAS</a>
    </li>
    <li>
      <a href="../articles/Test%202.html">Test2</a>
    </li>
    <li>
      <a href="../articles/Using%20aqua_light.html">4. Using aqua_light</a>
    </li>
    <li>
      <a href="../articles/Using%20stream_light.html">3. Using stream_light</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
          <a href="#" id="css-toggle-btn">
            <span class="fas fa-adjust fa-lg"></span>
          </a>
        </li>
        
        <li>
  <a href="https://github.com/psavoy/StreamLight/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
        
        


      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Using%20stream_light_files/header-attrs-2.8/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>3. Using stream_light</h1>
                        <h4 class="author">Phil Savoy</h4>
            
            <h4 class="date">5/17/2021</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/psavoy/StreamLight/blob/master/vignettes/Using%20stream_light.Rmd"><code>vignettes/Using stream_light.Rmd</code></a></small>
      <div class="hidden name"><code>Using stream_light.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This article will demonstrate creating estimates of photosynthetically active radiation (PAR) using the <strong><span style="color:DarkOrange">stream_light</span></strong> function.</p>
<p><strong>Outline</strong></p>
<ol style="list-style-type: decimal">
<li>
<u>Overview:</u> General overview of the function structure.</li>
<li>
<u>Preparing a driver file:</u> Assembling timeseries of model drivers to be fed into the model.</li>
<li>
<u>Preparing a parameter file:</u> Creating a parameter file that describes various site conditions.</li>
<li>
<u>Running <strong><span style="color:DarkOrange">stream_light</span></strong>:</u> Example code of how to run the model.</li>
</ol>
<div id="introduction-to-the-stream_light-function" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction-to-the-stream_light-function" class="anchor"></a>1. Introduction to the <span style="color:DarkOrange">stream_light</span> function</h2>
<p>First, let’s take a look at the <strong><span style="color:DarkOrange">stream_light</span></strong> function which has the following structure:</p>
<p><strong><span style="color:DarkOrange">stream_light</span></strong>(<em><span style="color:#009faf">driver_file</span></em>, <em><span style="color:#009faf">Lat</span></em>, <em><span style="color:#009faf">Lon</span></em>, <em><span style="color:#009faf">channel_azimuth</span></em>, <em><span style="color:#009faf">bottom_width</span></em>, <em><span style="color:#009faf">BH</span></em>, <em><span style="color:#009faf">BS</span></em>, <em><span style="color:#009faf">WL</span></em>, <em><span style="color:#009faf">TH</span></em>, <em><span style="color:#009faf">overhang_height</span></em>, <em><span style="color:#009faf">x_LAD</span></em>)</p>
<ul>
<li>
<em><span style="color:#009faf">driver_file</span></em> The model driver file</li>
<li>
<em><span style="color:#009faf">Lat</span></em> The site latitude</li>
<li>
<em><span style="color:#009faf">Lon</span></em> The site longitude</li>
<li>
<em><span style="color:#009faf">channel_azimuth</span></em> Channel azimuth</li>
<li>
<em><span style="color:#009faf">bottom_width</span></em> Bottom width (m)</li>
<li>
<em><span style="color:#009faf">BH</span></em> Bank height (m)</li>
<li>
<em><span style="color:#009faf">BS</span></em> Bank slope</li>
<li>
<em><span style="color:#009faf">WL</span></em> Water level (m)</li>
<li>
<em><span style="color:#009faf">TH</span></em> Tree height (m)</li>
<li>
<em><span style="color:#009faf">overhang</span></em> Maximum canopy overhang (m)</li>
<li>
<em><span style="color:#009faf">overhang_height</span></em> Height of the maximum canopy overhang (m). If overhang_height = NA, then the model defaults to a value of 75% of tree height.</li>
<li>
<em><span style="color:#009faf">x_LAD</span></em> Leaf angle distribution, default = 1</li>
</ul>
<p>Running <strong><span style="color:DarkOrange">stream_light</span></strong> model requires a parameter file that describes various site characteristics and a driver file that contains inputs into the model. The first argument for the function (<em><span style="color:#009faf">driver_file</span></em>) is a standardized model driver file that contains total incoming irradiance (W m<sup>-2</sup>) and leaf area index (LAI) (m<sup>2</sup> m<sup>-2</sup>) which are used as model inputs. The remaining arguments in the function are parameters that describe site characteristics. On the surface this seems like a large number of parameters;however, this tutorial provides more indepth information on each of these parameters and some simplifying assumptions that can be used to reduce the number of necessary parameters.</p>
</div>
<div id="preparing-a-driver-file" class="section level2">
<h2 class="hasAnchor">
<a href="#preparing-a-driver-file" class="anchor"></a>2. Preparing a driver file</h2>
<p>There are two necessary components to drive <strong><span style="color:DarkOrange">stream_light</span></strong>. First, incoming above canopy total irradiance (W m<sup>-2</sup>) is needed as an input into the radiative transfer model. Second, daily estimates of LAI are needed to determine the attenuation of light by canopies within the radiative transfer model. A set of functions is included in the <strong>StreamLightUtils</strong> package to help create a standardized model driver file.</p>
<p>The structure of the model driver is as follows:</p>
<ul>
<li>
<strong><span style="color:#009688">“local_time”</span></strong>: A POSIXct object in local time</li>
<li>
<strong><span style="color:#009688">“offset”</span></strong>: The UTC offset for local time (hours), used in the <strong><span style="color:DarkOrange">solar_c function</span></strong>
</li>
<li>
<strong><span style="color:#009688">“jday”</span></strong>: A unique identifier for each day that combines year and day of year information in the format YYYYddd</li>
<li>
<strong><span style="color:#009688">“DOY”</span></strong>: The day of year (1-365 or 366 for leap years)</li>
<li>
<strong><span style="color:#009688">“Hour”</span></strong>: Hour of the day (0-23)</li>
<li>
<strong><span style="color:#009688">“SW_inc”</span></strong>: Total incoming downwelling shortwave radiation (W m<sup>-2</sup>). <strong>StreamLightUtils</strong> provides tools to get hourly data from NLDAS.</li>
<li>
<strong><span style="color:#009688">“LAI”</span></strong>: MODIS leaf area index (m<sup>2</sup> m<sup>-2</sup>). <strong>StreamLightUtils</strong> provides tools to generate interpolated to daily values using the <strong><span style="color:DarkOrange">AppEEARS_proc</span></strong> function.</li>
</ul>
<p>A driver file with the same structure as above can be made using the <strong><span style="color:DarkOrange">make_driver</span></strong> function from <strong>StreamLightUtils</strong> which has the following structure:</p>
<p><strong><span style="color:DarkOrange">make_driver</span></strong>(<em><span style="color:#009faf">site_locs</span></em>, <em><span style="color:#009faf">NLDAS_processed</span></em>, <em><span style="color:#009faf">MOD_processed</span></em>, <em><span style="color:#009faf">write_output</span></em>, <em><span style="color:#009faf">save_dir</span></em>)</p>
<ul>
<li>
<em><span style="color:#009faf">site_locs</span></em> A table with Site_ID, Lat, and Lon, and the coordinate reference system designated as an EPSG code. For example, the most common geographic system is WGS84 and its EPSG code is 4326</li>
<li>
<em><span style="color:#009faf">NLDAS_processed</span></em> Output from the <strong><span style="color:DarkOrange">NLDAS_proc</span></strong> function (from <strong>StreamLightUtils</strong>)</li>
<li>
<em><span style="color:#009faf">MOD_processed</span></em> Output from the <strong><span style="color:DarkOrange">AppEEARS_proc</span></strong> function (from <strong>StreamLightUtils</strong>)</li>
<li>
<em><span style="color:#009faf">write_output</span></em> Logical value to indicate whether to write each individual driver file to disk. Default value is FALSE.</li>
<li>
<em><span style="color:#009faf">save_dir</span></em> Optional parameter when write_output = TRUE. The save directory for files to be placed in. For example, "C:/</li>
</ul>
<p>Let’s take a moment to examine the final structure of the driver file</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Read in a driver file</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">NC_NHC_driver</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">NC_NHC_driver</span><span class="op">)</span></code></pre></div>
</div>
<div id="preparing-a-parameter-file" class="section level2">
<h2 class="hasAnchor">
<a href="#preparing-a-parameter-file" class="anchor"></a>3. Preparing a parameter file</h2>
<p>There are several site parameters required to run <strong><span style="color:DarkOrange">stream_light</span></strong>; however, not all of these parameters have built in functions within <strong>StreamLightUtils</strong>. Similarly, not all parameters are easily obtained nor will they all have equal importance for model performance. Here, we detail the same process used to extract parameter values from <a href="https://www.journals.uchicago.edu/doi/10.1086/714270">Savoy et al. (2021)</a>. To begin with, let’s revisit the parameters used:</p>
<div class="figure">
<img src="../docs/images/diagram.png" alt=""><p class="caption">A schematic of various input parameters.</p>
</div>
<ul>
<li>
<em><span style="color:#009faf">Lat</span></em> The site latitude</li>
<li>
<em><span style="color:#009faf">Lon</span></em> The site longitude</li>
<li>
<em><span style="color:#009faf">channel_azimuth</span></em> Channel azimuth</li>
<li>
<em><span style="color:#009faf">bottom_width</span></em> Bottom width (m)</li>
<li>
<em><span style="color:#009faf">BH</span></em> Bank height (m)</li>
<li>
<em><span style="color:#009faf">BS</span></em> Bank slope</li>
<li>
<em><span style="color:#009faf">WL</span></em> Water level (m)</li>
<li>
<em><span style="color:#009faf">TH</span></em> Tree height (m)</li>
<li>
<em><span style="color:#009faf">overhang</span></em> Maximum canopy overhang (m)</li>
<li>
<em><span style="color:#009faf">overhang_height</span></em> Height of the maximum canopy overhang (m)</li>
<li>
<em><span style="color:#009faf">x_LAD</span></em> Leaf angle distribution</li>
</ul>
<p>To run the model on multiple sites it is easiest to construct a table of parameters for each site such as the following example.</p>
<div id="parameter-descriptions-and-values" class="section level3">
<h3 class="hasAnchor">
<a href="#parameter-descriptions-and-values" class="anchor"></a><strong>Parameter descriptions and values</strong>
</h3>
<div id="channel-azimuth-channel_azimuth" class="section level4">
<h4 class="hasAnchor">
<a href="#channel-azimuth-channel_azimuth" class="anchor"></a><strong>Channel azimuth (<em><span style="color:#009faf">channel_azimuth</span></em>)</strong>
</h4>
<p>Currently there is no functionality to derive stream azimuth within <strong>StreamLightUtils</strong>. In the meantime, these can be derived manually using aerial photographs, flowlines, or field derived measurements. Because we have based our model on SHADE2 (Li et al., 2012), we follow their conventions where stream azimuth is measured clockwise from North (see figure below). However, at present both banks are parameterized identically in <strong>StreamLight</strong> (e.g. only a single tree height is put in instead of the heights of trees on either bank) and so in reality a channel azimuth of 45<span class="math inline">\(^\circ\)</span> and 225<span class="math inline">\(^\circ\)</span> will yield the same results. We only mention this point in case future development may allow for parameterizing banks separately, or in case someone wanted to modify the code on their own to add in this functionality.</p>
<p>Example of deriving azimuth, note the first azimuth of the first example is 45<span class="math inline">\(^\circ\)</span> whereas the second example is 315<span class="math inline">\(^\circ\)</span>.</p>
<p><img src="../docs/images/measuring_stream_azimuth.png"></p>
</div>
<div id="width-bottom_width" class="section level4">
<h4 class="hasAnchor">
<a href="#width-bottom_width" class="anchor"></a><strong>Width (<em><span style="color:#009faf">bottom_width</span></em>)</strong>
</h4>
<p>The widths used in this tutorial are from field measurements. However, if field measurements are not available or feasible there are various remotely sensed products such as the <a href="http://gaia.geosci.unc.edu/NARWidth/">NARWidth dataset</a>from <a href="https://science.sciencemag.org/content/361/6402/585">Allen &amp; Pavelsky</a>. There are also empirically-derived estimates, such as those from <a href="https://www.nature.com/articles/sdata201917">McManamay *&amp; DeRolph, 2019</a>.</p>
</div>
<div id="bank-height-bh" class="section level4">
<h4 class="hasAnchor">
<a href="#bank-height-bh" class="anchor"></a><strong>Bank height (<em><span style="color:#009faf">BH</span></em>)</strong>
</h4>
<p>Without detailed information of bank heights a default value of 0.1m was used for all sites.</p>
</div>
<div id="bank-slope-bs" class="section level4">
<h4 class="hasAnchor">
<a href="#bank-slope-bs" class="anchor"></a><strong>Bank slope (<em><span style="color:#009faf">BS</span></em>)</strong>
</h4>
<p>Without detailed information of bank slopes a default value of 100 was used for all sites.</p>
</div>
<div id="water-level-wl" class="section level4">
<h4 class="hasAnchor">
<a href="#water-level-wl" class="anchor"></a><strong>Water level (<em><span style="color:#009faf">WL</span></em>)</strong>
</h4>
<p>Without detailed information of water level a default value of 0.1m was used for all sites.</p>
</div>
<div id="tree-height-th" class="section level4">
<h4 class="hasAnchor">
<a href="#tree-height-th" class="anchor"></a><strong>Tree height (<em><span style="color:#009faf">TH</span></em>)</strong>
</h4>
<p><strong>StreamLightUtils</strong> has a built in function to derive tree height using the LiDAR derived estimates of Simard et al. (2011). The function <strong><span style="color:DarkOrange">extract_height</span></strong> will retrieve an estimate of tree height (m) based on latitude and longitude and has the following structure:</p>
<p><strong><span style="color:DarkOrange">extract_height</span></strong>(<em><span style="color:#009faf">Site_ID</span></em>, <em><span style="color:#009faf">Lat</span></em>, <em><span style="color:#009faf">Lon</span></em>)</p>
<ul>
<li>
<em><span style="color:#009faf">Site_ID</span></em> The site identifier (“Site_ID”)</li>
<li>
<em><span style="color:#009faf">Lat</span></em> The site latitude</li>
<li>
<em><span style="color:#009faf">Lon</span></em> The site longitude</li>
<li>
<em><span style="color:#009faf">site_crs</span></em> The coordinate reference system of the points, preferably designated as an EPSG code. For example, the most common geographic system is WGS84 and its EPSG code is 4326.</li>
</ul>
<p>Although this parameter file already contains tree height, the following is an example of how to use this funciton</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Extract tree height</span>
  <span class="fu"><a href="https://rdrr.io/pkg/StreamLightUtils/man/extract_height.html">extract_height</a></span><span class="op">(</span>
    Site_ID <span class="op">=</span> <span class="va">NC_params</span><span class="op">[</span>, <span class="st">"Site_ID"</span><span class="op">]</span>, 
    Lat <span class="op">=</span> <span class="va">NC_params</span><span class="op">[</span>, <span class="st">"Lat"</span><span class="op">]</span>,
    Lon <span class="op">=</span> <span class="va">NC_params</span><span class="op">[</span>, <span class="st">"Lon"</span><span class="op">]</span>,
    site_crs <span class="op">=</span> <span class="va">NC_params</span><span class="op">[</span>, <span class="st">"epsg_crs"</span><span class="op">]</span>
  <span class="op">)</span></code></pre></div>
</div>
<div id="maximum-canopy-overhang-overhang" class="section level4">
<h4 class="hasAnchor">
<a href="#maximum-canopy-overhang-overhang" class="anchor"></a><strong>Maximum canopy overhang (<em><span style="color:#009faf">overhang</span></em>)</strong>
</h4>
<p>Without detailed information on canopy overhang it was assumed that overhang was 10% of tree height at all sites.</p>
</div>
<div id="height-of-maximum-canopy-overhang-overhang_height" class="section level4">
<h4 class="hasAnchor">
<a href="#height-of-maximum-canopy-overhang-overhang_height" class="anchor"></a><strong>Height of maximum canopy overhang (<em><span style="color:#009faf">overhang_height</span></em>)</strong>
</h4>
<p>Without detailed information on the height of maximum canopy overhang a value of NA can be used. When <em><span style="color:#009faf">overhang_height</span></em> = NA, the model will default to using 75% of tree height.</p>
</div>
<div id="leaf-angle-distributionx_lad" class="section level4">
<h4 class="hasAnchor">
<a href="#leaf-angle-distributionx_lad" class="anchor"></a><strong>Leaf angle distribution(<em><span style="color:#009faf">x_LAD</span></em>)</strong>
</h4>
<p>Most canopies can be approximated by a spherical distribution of leaf angles (<em>x</em> = 1) (Campbell &amp; Norman, 1998), and so <em><span style="color:#009faf">x_LAD</span></em> was set to 1 at all sites.</p>
</div>
</div>
</div>
<div id="running-streamlight" class="section level2">
<h2 class="hasAnchor">
<a href="#running-streamlight" class="anchor"></a>4. Running StreamLight</h2>
<p>First time installation of the <strong>StreamLight</strong> package from GitHub can be done with the devtools library and once installed, the package can be loaded as normal.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span><span class="op">(</span><span class="st">"psavoy/StreamLight"</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/psavoy/StreamLight">"StreamLight"</a></span><span class="op">)</span></code></pre></div>
<p>Estimates of average light across a transect can be estimated using the <strong><span style="color:DarkOrange">stream_light</span></strong> function which has the following structure:</p>
<p><strong><span style="color:DarkOrange">stream_light</span></strong>(<em><span style="color:#009faf">driver_file</span></em>, <em><span style="color:#009faf">Lat</span></em>, <em><span style="color:#009faf">Lon</span></em>, <em><span style="color:#009faf">channel_azimuth</span></em>, <em><span style="color:#009faf">bottom_width</span></em>, <em><span style="color:#009faf">BH</span></em>, <em><span style="color:#009faf">BS</span></em>, <em><span style="color:#009faf">WL</span></em>, <em><span style="color:#009faf">TH</span></em>, <em><span style="color:#009faf">overhang_height</span></em>, <em><span style="color:#009faf">x_LAD</span></em>)</p>
<ul>
<li>
<em><span style="color:#009faf">driver_file</span></em> The model driver file</li>
<li>
<em><span style="color:#009faf">Lat</span></em> The site latitude</li>
<li>
<em><span style="color:#009faf">Lon</span></em> The site longitude</li>
<li>
<em><span style="color:#009faf">channel_azimuth</span></em> Channel azimuth</li>
<li>
<em><span style="color:#009faf">bottom_width</span></em> Bottom width (m)</li>
<li>
<em><span style="color:#009faf">BH</span></em> Bank height (m)</li>
<li>
<em><span style="color:#009faf">BS</span></em> Bank slope</li>
<li>
<em><span style="color:#009faf">WL</span></em> Water level (m)</li>
<li>
<em><span style="color:#009faf">TH</span></em> Tree height (m)</li>
<li>
<em><span style="color:#009faf">overhang</span></em> Maximum canopy overhang (m)</li>
<li>
<em><span style="color:#009faf">overhang_height</span></em> Height of the maximum canopy overhang (m). If overhang_height = NA, then the model defaults to a value of 75% of tree height.</li>
<li>
<em><span style="color:#009faf">x_LAD</span></em> Leaf angle distribution, default = 1</li>
</ul>
<p>As outlined in the previous section on preparing parameter files. In <a href="https://www.journals.uchicago.edu/doi/10.1086/714270">Savoy et al. (2021)</a> we made some simplifying assumptions to facilitate applying this model easily to locations that lacked detailed <strong>in situ</strong> measurements.</p>
<div id="generate-estimates-for-a-single-site" class="section level3">
<h3 class="hasAnchor">
<a href="#generate-estimates-for-a-single-site" class="anchor"></a><strong>Generate estimates for a single site</strong>
</h3>
<p>To run the model for a single site simply add the parameters to the function.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Load the example driver file for NC_NHC</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">NC_NHC_driver</span><span class="op">)</span>

<span class="co">#Run the model</span>
  <span class="va">NC_NHC_modeled</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stream_light.html">stream_light</a></span><span class="op">(</span>
    <span class="va">NC_NHC_driver</span>, 
    Lat <span class="op">=</span> <span class="fl">35.9925</span>, 
    Lon <span class="op">=</span> <span class="op">-</span><span class="fl">79.0460</span>, 
    channel_azimuth <span class="op">=</span> <span class="fl">330</span>, 
    bottom_width <span class="op">=</span> <span class="fl">18.9</span>, 
    BH <span class="op">=</span> <span class="fl">0.1</span>, 
    BS <span class="op">=</span> <span class="fl">100</span>, 
    WL <span class="op">=</span> <span class="fl">0.1</span>, 
    TH <span class="op">=</span> <span class="fl">23</span>, 
    overhang <span class="op">=</span> <span class="fl">2.3</span>, 
    overhang_height <span class="op">=</span> <span class="cn">NA</span>, 
    x_LAD <span class="op">=</span> <span class="fl">1</span>
  <span class="op">)</span></code></pre></div>
</div>
<div id="generate-estimates-for-multiple-sites" class="section level3">
<h3 class="hasAnchor">
<a href="#generate-estimates-for-multiple-sites" class="anchor"></a><strong>Generate estimates for multiple sites</strong>
</h3>
<p>It is also possible to then loop over multiple sites by wrapping the model in another function and below is an example of this that could be adapted to your own workflow.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Function for batching over multiple sites</span>
  <span class="va">batch_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">Site</span>, <span class="va">read_dir</span>, <span class="va">save_dir</span><span class="op">)</span><span class="op">{</span>
    <span class="co">#Get the model driver</span>
      <span class="va">driver_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">read_dir</span>, <span class="st">"/"</span>, <span class="va">Site</span>, <span class="st">"_driver.rds"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span>

    <span class="co">#Get model parameters for the site</span>
      <span class="va">site_p</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">[</span><span class="va">params</span><span class="op">[</span>, <span class="st">"Site_ID"</span><span class="op">]</span> <span class="op">==</span> <span class="va">Site</span>, <span class="op">]</span>

    <span class="co">#Run the model</span>
      <span class="va">modeled</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stream_light.html">stream_light</a></span><span class="op">(</span>
        <span class="va">driver_file</span>, 
        Lat <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"Lat"</span><span class="op">]</span>, 
        Lon <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"Lon"</span><span class="op">]</span>,
        channel_azimuth <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"Azimuth"</span><span class="op">]</span>, 
        bottom_width <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"Width"</span><span class="op">]</span>, 
        BH <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"BH"</span><span class="op">]</span>,
        BS <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"BS"</span><span class="op">]</span>, 
        WL <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"WL"</span><span class="op">]</span>, 
        TH <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"TH"</span><span class="op">]</span>, 
        overhang <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"overhang"</span><span class="op">]</span>,
        overhang_height <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"overhang_height"</span><span class="op">]</span>, 
        x_LAD <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"x"</span><span class="op">]</span>
      <span class="op">)</span>

    <span class="co">#Save the output</span>
      <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">modeled</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">save_dir</span>, <span class="st">"/"</span>, <span class="va">Site</span>, <span class="st">"_predicted.rds"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span>

  <span class="op">}</span> <span class="co">#End batch_model </span>

<span class="co">#Applying the model to all sites</span>
  <span class="va">model_rd</span> <span class="op">&lt;-</span> <span class="va">working_dir</span>
  <span class="va">model_sd</span> <span class="op">&lt;-</span> <span class="va">working_dir</span>

<span class="co">#Running the model</span>
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
    <span class="va">params</span><span class="op">[</span>, <span class="st">"Site_ID"</span><span class="op">]</span>, 
    FUN <span class="op">=</span> <span class="va">batch_model</span>, 
    read_dir <span class="op">=</span> <span class="va">model_rd</span>,
    save_dir <span class="op">=</span> <span class="va">model_sd</span>
  <span class="op">)</span> 

<span class="co">#Take a look at the output</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">NC_NHC_predicted</span><span class="op">)</span>
  <span class="va">NC_NHC_predicted</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="op">]</span></code></pre></div>
<p>The columns are as follows:</p>
<ul>
<li>
<strong><span style="color:#009688">“local_time”</span></strong>: A POSIXct object in local time</li>
<li>
<strong><span style="color:#009688">“offset”</span></strong>: The UTC offset for local time (hours), used in the <strong><span style="color:DarkOrange">solar_c function</span></strong>
</li>
<li>
<strong><span style="color:#009688">“jday”</span></strong>: A unique identifier for each day that combines year and day of year information in the format YYYYddd</li>
<li>
<strong><span style="color:#009688">“DOY”</span></strong>: The day of year (1-365 or 366 for leap years)</li>
<li>
<strong><span style="color:#009688">“Hour”</span></strong>: Hour of the day (0-23)</li>
<li>
<strong><span style="color:#009688">“SW_inc”</span></strong>: Total incoming downwelling shortwave radiation (W m<sup>-2</sup>). <strong>StreamLightUtils</strong> provides tools to get hourly data from NLDAS.</li>
<li>
<strong><span style="color:#009688">“LAI”</span></strong>: MODIS leaf area index (m<sup>2</sup> m<sup>-2</sup>). <strong>StreamLightUtils</strong> provides tools to generate interpolated to daily values using the <strong><span style="color:DarkOrange">AppEEARS_proc</span></strong> function.</li>
<li>
<strong><span style="color:#009688">“PAR_inc”</span></strong>: Incoming PAR above the canopy (<font size="+1"><span class="math inline">\(\mu\)</span></font>mol m<sup>-2</sup> s<sup>-1</sup>)</li>
<li>
<strong><span style="color:#009688">“PAR_bc”</span></strong>: Estimated PAR (<font size="+1"><span class="math inline">\(\mu\)</span></font>mol m<sup>-2</sup> s<sup>-1</sup>) directly below the canopy</li>
<li>
<strong><span style="color:#009688">“veg_shade”</span></strong>: The proportion of the channel crossection that is shaded by riparian vegetation</li>
<li>
<strong><span style="color:#009688">“bank_shade”</span></strong>: The proportion of the channel crossection that is shaded by stream banks</li>
<li>
<strong><span style="color:#009688">“PAR_stream”</span></strong>: The estimated PAR for the channel cross section (<font size="+1"><span class="math inline">\(\mu\)</span></font>mol m<sup>-2</sup> s<sup>-1</sup>)</li>
</ul>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Phil Savoy.</p>
</div>

<div class="pkgdown">
  <p>Made with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1, using <a href="https://preferably.amirmasoudabdol.name/?source=footer">preferably</a> template.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
