<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Inform modern browsers that this page supports both dark and light color schemes,
  and the page author prefers light. --><meta name="color-scheme" content="dark light">
<script>
  // If `prefers-color-scheme` is not supported, fall back to light mode.
  // i.e. In this case, inject the `light` CSS before the others, with
  // no media filter so that it will be downloaded with highest priority.
  if (window.matchMedia("(prefers-color-scheme: dark)").media === "not all") {
    document.documentElement.style.display = "none";
    document.head.insertAdjacentHTML(
      "beforeend",
      "<link id=\"css\" rel=\"stylesheet\" href=\"https://bootswatch.com/3/flatly/bootstrap.css\" onload=\"document.documentElement.style.display = ''\">"
    );
  }
</script><title>4. Using aqua_light • StreamLight</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- Flatly Theme - Light  --><link id="css-light" rel="stylesheet" href="https://bootswatch.com/3/flatly/bootstrap.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
<!-- Darkly Theme - Dark --><link id="css-dark" rel="stylesheet" href="https://bootswatch.com/3/darkly/bootstrap.css" media="(prefers-color-scheme: dark)">
<!-- preferably CSS --><link rel="stylesheet" href="../preferably.css">
<link id="css-code-light" rel="stylesheet" href="../code-color-scheme-light.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
<link id="css-code-dark" rel="stylesheet" href="../code-color-scheme-dark.css" media="(prefers-color-scheme: dark)">
<script src="../darkswitch.js"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="4. Using aqua_light">
<meta property="og:description" content="StreamLight">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">StreamLight</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/1%20Download%20and%20process%20NLDAS.html">1. Download and process NLDAS</a>
    </li>
    <li>
      <a href="../articles/2%20Download%20and%20process%20MODIS%20LAI.html">2. Download and process MODIS LAI</a>
    </li>
    <li>
      <a href="../articles/3%20Using%20stream_light.html">3. Using stream_light</a>
    </li>
    <li>
      <a href="../articles/4%20Using%20aqua_light.html">4. Using aqua_light</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
          <a href="#" id="css-toggle-btn">
            <span class="fas fa-adjust fa-lg"></span>
          </a>
        </li>
        
        <li>
  <a href="https://github.com/psavoy/StreamLight/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
        
        


      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="4%20Using%20aqua_light_files/header-attrs-2.8/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>4. Using aqua_light</h1>
                        <h4 class="author">Phil Savoy</h4>
            
            <h4 class="date">5/17/2021</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/psavoy/StreamLight/blob/master/vignettes/4%20Using%20aqua_light.Rmd"><code>vignettes/4 Using aqua_light.Rmd</code></a></small>
      <div class="hidden name"><code>4 Using aqua_light.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This article will demonstrate creating estimates of photosynthetically active radiation (PAR) using the <strong><span style="color:DarkOrange">aqua_light</span></strong> function. The details and application of this model are detailed in <a href="https://agupubs.onlinelibrary.wiley.com/doi/abs/10.1029/2020GL092149">Savoy &amp; Harvey. (2021a)</a>, and the modeled estimates from this paper are available in a <a href="https://www.sciencebase.gov/catalog/item/5f974adfd34e198cb77db168">ScienceBase data release (Savoy &amp; Harvey, 2021b)</a>.</p>
<p>There are many ways to derive values for site parameters or model drivers; however, this document focuses on the approaches used in <a href="https://agupubs.onlinelibrary.wiley.com/doi/abs/10.1029/2020GL092149">Savoy &amp; Harvey. (2021a)</a> and does not give an exhaustive set of possibilities.</p>
<p><strong>Outline</strong></p>
<ol style="list-style-type: decimal">
<li>
<u>Overview:</u> General overview of the function structure.</li>
<li>
<u>Preparing a driver file:</u> Assembling timeseries of model drivers to be fed into the model.</li>
<li>
<u>Preparing a parameter file:</u> Creating a parameter file that describes various site conditions.</li>
<li>
<u>Running <strong><span style="color:DarkOrange">aqua_light</span></strong>:</u> Example code of how to run the model to generate estimates in this data release and brief explanation of model outputs.</li>
<li>
<u>Appendix:</u> Governing equations for light reflection and attenuation as a function of depth and clarity.</li>
</ol>
<div id="introduction-to-the-aqua_light-function" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction-to-the-aqua_light-function" class="anchor"></a>1. Introduction to the <strong><span style="color:DarkOrange">aqua_light</span></strong> function</h2>
<p>This tutorial will cover the basic model inputs, model structure, and model outputs. First, let’s take a look at the <strong><span style="color:DarkOrange">aqua_light</span></strong> function which has the following structure:</p>
<p><strong><span style="color:DarkOrange">aqua_light</span></strong>(<em><span style="color:#009faf">driver_file</span></em>, <em><span style="color:#009faf">Lat</span></em>, <em><span style="color:#009faf">Lon</span></em>, <em><span style="color:#009faf">channel_azimuth</span></em>, <em><span style="color:#009faf">bankfull_width</span></em>, <em><span style="color:#009faf">BH</span></em>, <em><span style="color:#009faf">TH</span></em>, <em><span style="color:#009faf">overhang</span></em>, <em><span style="color:#009faf">overhang_height</span></em>, <em><span style="color:#009faf">x_LAD</span></em>)</p>
<ul>
<li>
<em><span style="color:#009faf">driver_file</span></em> The model driver file</li>
<li>
<em><span style="color:#009faf">Lat</span></em> The site latitude</li>
<li>
<em><span style="color:#009faf">Lon</span></em> The site longitude</li>
<li>
<em><span style="color:#009faf">channel_azimuth</span></em> Channel azimuth</li>
<li>
<em><span style="color:#009faf">bankfull width</span></em> Bankfull width (m)</li>
<li>
<em><span style="color:#009faf">BH</span></em> Bankfull height (m)</li>
<li>
<em><span style="color:#009faf">TH</span></em> Tree height (m)</li>
<li>
<em><span style="color:#009faf">overhang</span></em> Maximum canopy overheight (m)</li>
<li>
<em><span style="color:#009faf">overhang_height</span></em> Height of the maximum canopy overhang (m). If overhang_height = NA, then the model defaults to a value of 75% of tree height.</li>
<li>
<em><span style="color:#009faf">x_LAD</span></em> Leaf angle distribution, default = 1</li>
</ul>
<p>Running <strong><span style="color:DarkOrange">aqua_light</span></strong> model requires a parameter file that describes various site characteristics and a driver file that contains inputs into the model. The first argument for the function (<em><span style="color:#009faf">driver_file</span></em>) is a standardized model driver file that contains timeseries of model inputs. The remaining arguments in the function are parameters that describe site characteristics. Section 2 gives more information about creating a model driver file and section 3 details the creation of a site parameter file.</p>
</div>
<div id="preparing-a-driver-file" class="section level2">
<h2 class="hasAnchor">
<a href="#preparing-a-driver-file" class="anchor"></a>2. Preparing a driver file</h2>
<p>The structure of the model driver is as follows:</p>
<ul>
<li>
<strong><span style="color:#009688">“local_time”</span></strong>: Local time in the format YYYY-mm-dd HH:MM:SS based on the site timezone</li>
<li>
<strong><span style="color:#009688">“offset”</span></strong>: The UTC offset for local time (hours)</li>
<li>
<strong><span style="color:#009688">“jday”</span></strong>: A unique identifier for each day that combines year and day of year information in the format YYYYddd</li>
<li>
<strong><span style="color:#009688">“Year”</span></strong> The year</li>
<li>
<strong><span style="color:#009688">“DOY”</span></strong>: The day of year (1-365 or 366 for leap years)</li>
<li>
<strong><span style="color:#009688">“Hour”</span></strong>: Hour of the day (0-23)</li>
<li>
<strong><span style="color:#009688">“SW_inc”</span></strong>: Total incoming downwelling shortwave radiation (W m<sup>-2</sup>). <strong>StreamLightUtils</strong> provides tools to get hourly data from NLDAS.</li>
<li>
<strong><span style="color:#009688">“LAI”</span></strong>: MODIS leaf area index (m<sup>2</sup> m<sup>-2</sup>). <strong>StreamLightUtils</strong> provides tools to generate interpolated to daily values using the <strong><span style="color:DarkOrange">AppEEARS_proc</span></strong> function.</li>
<li>
<strong><span style="color:#009688">“depth”</span></strong>: Water depth (m)</li>
<li>
<strong><span style="color:#009688">“width”</span></strong>: Wetted width (m)</li>
<li>
<strong><span style="color:#009688">“kd_pred”</span></strong>: The irradiance attenuation coefficient (m <sup>-1</sup>)</li>
</ul>
<p>Preparing a driver file may depend on available data at a site or the needs of individual researchers. The <a href="https://github.com/psavoy/StreamLightUtils"><strong>StreamLightUtils</strong></a> package provides utilities to generate a standardized driver file that contains <strong><span style="color:#009688">“local_time”</span></strong>, <strong><span style="color:#009688">“offset”</span></strong>, <strong><span style="color:#009688">“jday”</span></strong>, <strong><span style="color:#009688">“Year”</span></strong>, <strong><span style="color:#009688">“DOY”</span></strong>, <strong><span style="color:#009688">“Hour”</span></strong>, <strong><span style="color:#009688">“SW_inc”</span></strong>, and <strong>LAI</strong>. The following sections provide information about the approaches used in <a href="https://agupubs.onlinelibrary.wiley.com/doi/abs/10.1029/2020GL092149">Savoy &amp; Harvey. (2021a)</a> to derive <strong><span style="color:#009688">“depth”</span></strong>, <strong><span style="color:#009688">“width”</span></strong>, and <strong><span style="color:#009688">“kd_pred”</span></strong>.</p>
<div id="depth-depth" class="section level3">
<h3 class="hasAnchor">
<a href="#depth-depth" class="anchor"></a>Depth (<strong><span style="color:#009688">“depth”</span></strong>)</h3>
<p>Depth could be measured or estimated in a variety of ways, and one possibility is to estimate depth as a function of discharge and hydraulic geometry coefficients following <a href="https://doi.org/10.1038/ngeo2567">Gomez-Velez et al. (2015)</a> (depth = <em>c</em> * Q<em><sup>f</sup></em>), where Q is discharge (m<sup>3</sup> s<sup>-1</sup>) and the terms <em>c</em> and <em>f</em> are empirical coefficients. The hydraulic geometry coefficients of <a href="https://doi.org/10.1038/ngeo2567">Gomez-Velez et al. (2015)</a> are included in the <a href="https://www.sciencebase.gov/catalog/item/59bff507e4b091459a5e0982">Appling et al. (2018)</a> for 356 U.S. rivers; however, since <a href="https://www.sciencebase.gov/catalog/item/59bff507e4b091459a5e0982">Appling et al. (2018)</a> have already done this conversion we have used their values. These depths represent mean depth averaged over the reach length and width for the date (4am to 3:59pm).</p>
</div>
<div id="width-width" class="section level3">
<h3 class="hasAnchor">
<a href="#width-width" class="anchor"></a>Width (<strong><span style="color:#009688">“width”</span></strong>)</h3>
<p>Similar to depth, we estimated width as a function of discharge and the hydraulic geometry coefficients following <a href="https://doi.org/10.1038/ngeo2567">Gomez-Velez et al. (2015)</a> (width = <em>a</em> * Q<em><sup>b</sup></em>), where Q is discharge (m<sup>3</sup> s<sup>-1</sup>) and the terms <em>a</em> and <em>b</em> are empirical coefficients. We used mean daily discharge to calculate mean width for the date (4am to 3:59pm).</p>
</div>
<div id="irradiance-attenuation-coefficient-kd_pred" class="section level3">
<h3 class="hasAnchor">
<a href="#irradiance-attenuation-coefficient-kd_pred" class="anchor"></a>Irradiance attenuation coefficient (<strong><span style="color:#009688">“kd_pred”</span></strong>)</h3>
<p>To get a timeseries of irradiance attenuation coefficients (<em>K<sub>d</sub></em>) we developed an empirical log-log linear relationship between turbidity (FNU) and <em>K<sub>d</sub></em>: <span class="math display">\[
log(K_d) = 0.52 * log(turbidity) - 0.26
\]</span></p>
</div>
</div>
<div id="preparing-a-parameter-file" class="section level2">
<h2 class="hasAnchor">
<a href="#preparing-a-parameter-file" class="anchor"></a>3. Preparing a parameter file</h2>
<div id="channel-azimuth-channel_azimuth" class="section level3">
<h3 class="hasAnchor">
<a href="#channel-azimuth-channel_azimuth" class="anchor"></a>Channel azimuth (<em><span style="color:#009faf">channel_azimuth</span></em>)</h3>
<p>Currently there is no functionality to derive stream azimuth within the <strong>StreamLightUtils</strong> package. In the meantime, these can be derived manually using aerial photographs, flowlines, or field derived measurements. The functions used to calculate shading <a href="https://www.sciencedirect.com/science/article/abs/pii/S0022169412000753">(Li et al., 2012)</a> follow the convention where stream azimuth is measured clockwise from North. However, since both banks are parameterized identically in both <strong><span style="color:DarkOrange">stream_light</span></strong> and *<strong><span style="color:DarkOrange">aqua_light</span></strong>, this distinction is less relevant and an azimuth of 45<span class="math inline">\(^{\circ}\)</span> and 225<span class="math inline">\(^\circ\)</span> will yield the same results. We only mention this point in case future development may allow for parameterizing banks separately, or in case someone wanted to modify the code on their own to add in this functionality.</p>
<p>Example of deriving azimuth, note the first azimuth of the first example is 45<span class="math inline">\(^\circ\)</span> whereas the second example is 315<span class="math inline">\(^\circ\)</span>.</p>
<p><img src="../docs/images/measuring_stream_azimuth.png"></p>
</div>
<div id="bankfull-width-bankfull_width" class="section level3">
<h3 class="hasAnchor">
<a href="#bankfull-width-bankfull_width" class="anchor"></a>Bankfull width (<em><span style="color:#009faf">bankfull_width</span></em>)</h3>
<p>We estimated bankfull channel width from regionalized hydraulic geometry coefficients as a function of discharge <a href="https://doi.org/10.1038/ngeo2567">(Gomez-Velez et al. 2015)</a>. Bankfull widths could also be acquired field measurements or several remotely-sensed or empirically-derived products.</p>
</div>
<div id="bank-height-bh" class="section level3">
<h3 class="hasAnchor">
<a href="#bank-height-bh" class="anchor"></a>Bank height (<em><span style="color:#009faf">BH</span></em>)</h3>
<p>We estimated bank heights based on the maximum predicted water depth at each site, but field surveys or LiDAR data could be alternative sources to derive this parameter.</p>
</div>
<div id="tree-height-th" class="section level3">
<h3 class="hasAnchor">
<a href="#tree-height-th" class="anchor"></a>Tree height (<em><span style="color:#009faf">TH</span></em>)</h3>
<p>Tree heights were derived from global estimates of canopy heights at 30m resolution from <a href="https://www.sciencedirect.com/science/article/abs/pii/S0034425720305381?dgcid=rss_sd_all">Potapov et al. (2021)</a>. The 90th percentile of tree height within a 60m buffer into the riparian zone was calculated for each site.</p>
<p>Alternatively, users can use the <strong><span style="color:DarkOrange">extract_height</span></strong> function from the <strong>StreamLightUtils</strong> package to extract 1km LiDAR data from Simard et al. (2011) based on latitude and longitude.</p>
</div>
<div id="maximum-canopy-overhang-overhang" class="section level3">
<h3 class="hasAnchor">
<a href="#maximum-canopy-overhang-overhang" class="anchor"></a>Maximum canopy overhang (<em><span style="color:#009faf">overhang</span></em>)</h3>
<p>Without detailed information on canopy overhang it was assumed that overhang was 10% of tree height at all sites. In <a href="https://www.journals.uchicago.edu/doi/10.1086/714270">Savoy et al. (2021)</a> a 10% overhang was used to validate the <strong><span style="color:DarkOrange">stream_light</span></strong> function; however, this is a rather simple assumption. <a href="https://www.journals.uchicago.edu/doi/10.1086/714270">Savoy et al. (2021)</a> gives some suggestions of potential data sources that could be used to refine these estimates.</p>
</div>
<div id="height-of-maximum-canopy-overhang-overhang_height" class="section level3">
<h3 class="hasAnchor">
<a href="#height-of-maximum-canopy-overhang-overhang_height" class="anchor"></a>Height of maximum canopy overhang (<em><span style="color:#009faf">overhang_height</span></em>)</h3>
<p>Without detailed information on the height of maximum canopy overhang a value of NA can be used. When <em><span style="color:#009faf">overhang_height</span></em> = NA, the model will default to using 75% of tree height.</p>
</div>
<div id="leaf-angle-distribution-x_lad" class="section level3">
<h3 class="hasAnchor">
<a href="#leaf-angle-distribution-x_lad" class="anchor"></a>Leaf angle distribution (<em><span style="color:#009faf">x_LAD</span></em>)</h3>
<p>Most canopies can be approximated by a spherical distribution of leaf angles (<em>x</em> = 1) (Campbell &amp; Norman, 1998), and so <em><span style="color:#009faf">x_LAD</span></em> was set to 1 at all sites.</p>
</div>
</div>
<div id="running-aqua_light" class="section level2">
<h2 class="hasAnchor">
<a href="#running-aqua_light" class="anchor"></a>4 Running <strong><span style="color:DarkOrange">aqua_light</span></strong>
</h2>
<p>As part of a ScienceBase data release <a href="https://www.sciencebase.gov/catalog/item/5f974adfd34e198cb77db168">(Savoy &amp; Harvey, 2021b)</a>, a prepared R environment (loaded_environment.RData) contains necessary inputs and outputs from <strong><span style="color:DarkOrange">aqua_light</span></strong>. This data is used below to demonstrate the use of <strong><span style="color:DarkOrange">aqua_light</span></strong>. Before beginning it is necessary to download and load in the prepared R environment (loaded_environment.RData) using the load command. For example if this file was located in the C:/ directory:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"C:/loaded_environment.RData"</span><span class="op">)</span></code></pre></div>
<p>To easily run the model across many sites a wrapper function is included below. This will get the relevant parameters and driver files for each site and return the modeled estimates</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">batch_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">Site_ID</span>, <span class="va">model_parameters</span>, <span class="va">model_drivers</span><span class="op">)</span><span class="op">{</span>
  <span class="co">#Print a message to keep track of progress</span>
    <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Generating modeled estimates for "</span>, <span class="va">Site_ID</span><span class="op">)</span><span class="op">)</span>
      
  <span class="co">#Get the model driver</span>
    <span class="va">driver_file</span> <span class="op">&lt;-</span> <span class="va">model_drivers</span><span class="op">[[</span><span class="va">Site_ID</span><span class="op">]</span><span class="op">]</span>
      
  <span class="co">#The input_output file contains the model inputs and outputs, let's select just the necessary</span>
  <span class="co">#input columns to reduce confusion</span>
    <span class="va">model_driver</span> <span class="op">&lt;-</span> <span class="va">driver_file</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"local_time"</span>, <span class="st">"offset"</span>, <span class="st">"jday"</span>, <span class="st">"Year"</span>, <span class="st">"DOY"</span>, <span class="st">"Hour"</span>, <span class="st">"SW_inc"</span>,
      <span class="st">"LAI"</span>, <span class="st">"kd_pred"</span>, <span class="st">"depth"</span>, <span class="st">"width"</span><span class="op">)</span><span class="op">]</span>
   
  <span class="co">#Get model parameters for the site</span>
    <span class="va">site_p</span> <span class="op">&lt;-</span> <span class="va">model_parameters</span><span class="op">[</span><span class="va">model_parameters</span><span class="op">[</span>, <span class="st">"Site_ID"</span><span class="op">]</span> <span class="op">==</span> <span class="va">Site_ID</span>, <span class="op">]</span>
    
  <span class="co">#Run the model</span>
    <span class="va">modeled</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aqua_light.html">aqua_light</a></span><span class="op">(</span>
      driver_file <span class="op">=</span> <span class="va">model_driver</span>, 
      Lat <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"Lat"</span><span class="op">]</span>, 
      Lon <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"Lon"</span><span class="op">]</span>,
      channel_azimuth <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"Azimuth"</span><span class="op">]</span>, 
      bankfull_width <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"width_harvey"</span><span class="op">]</span>, 
      BH <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"bank_height"</span><span class="op">]</span>,
      TH <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"TH"</span><span class="op">]</span>, 
      overhang <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"overhang"</span><span class="op">]</span>,
      overhang_height <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"overhang_height"</span><span class="op">]</span>,
      x_LAD <span class="op">=</span> <span class="va">site_p</span><span class="op">[</span>, <span class="st">"x"</span><span class="op">]</span>
    <span class="op">)</span>
    
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">modeled</span><span class="op">)</span>
      
<span class="op">}</span> <span class="co">#End batch_model</span></code></pre></div>
<p>The next step is to simply apply this function across all sites. Here, the model drivers have been placed into a single list to easily loop over each site driver file.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">modeled_estimates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">inputs_outputs</span><span class="op">)</span>,
  FUN <span class="op">=</span> <span class="va">batch_model</span>,
  model_parameters <span class="op">=</span> <span class="va">site_parameters</span>,
  model_drivers <span class="op">=</span> <span class="va">inputs_outputs</span>
<span class="op">)</span></code></pre></div>
<p>The modeled output contains the following columns:</p>
<ul>
<li><p><strong><span style="color:#009688">“local_time”</span></strong>: Local time in the format YYYY-mm-dd HH:MM:SS based on the site timezone</p></li>
<li><p><strong><span style="color:#009688">“offset”</span></strong>: The UTC offset for local time (hours)</p></li>
<li><p><strong><span style="color:#009688">“jday”</span></strong>: A unique identifier for each day that combines year and day of year information in the format YYYYddd</p></li>
<li><p><strong><span style="color:#009688">“Year”</span></strong> The year</p></li>
<li><p><strong><span style="color:#009688">“DOY”</span></strong>: The day of year (1-365 or 366 for leap years)</p></li>
<li><p><strong><span style="color:#009688">“Hour”</span></strong>: Hour of the day (0-23)</p></li>
<li><p><strong><span style="color:#009688">“SW_inc”</span></strong>: Total incoming downwelling shortwave radiation (W m<sup>-2</sup>). <strong>StreamLightUtils</strong> provides tools to get hourly data from NLDAS. Specifically, the data used in this example is from the North American Land Data Assimilation System (NLDAS) (original attribute name DSWRFsfc) . This data was downloaded and processed using the <strong>StreamLightUtils</strong> package.</p></li>
<li><p><strong><span style="color:#009688">“LAI”</span></strong>: MODIS leaf area index (m<sup>2</sup> m<sup>-2</sup>). <strong>StreamLightUtils</strong> provides tools to generate interpolated to daily values using the <strong><span style="color:DarkOrange">AppEEARS_proc</span></strong> function. Specifically, the data used in this example is MODIS 8-day 500m leaf area index (MCD15A2H-006). This data has been interpolated to daily values following the method of <a href="https://doi.org/10.1007/978-1-4419-0026-5_2">Gu et al. (2009)</a> using the <strong>StreamLightUtils</strong> package, which leverages these routines from the <a href="https://cran.r-project.org/web/packages/phenofit/index.html"><strong>phenofit</strong></a> R package.</p></li>
<li><p><strong><span style="color:#009688">“depth”</span></strong>: Water depth (m). Specifically, the data used in this example is mean depth (m), averaged over the reach length and width, for the date (4am to 3:59pm) from <a href="https://www.sciencebase.gov/catalog/item/59bff507e4b091459a5e0982">Appling et al. (2018)</a>.</p></li>
<li><p><strong><span style="color:#009688">“width”</span></strong>: Wetted width (m). Specifically, the data used in this example is mean width (m) for the date (4am to 3:59pm) calculated from the mean discharge and the equation to estimate width as a function of discharge (width = a * Qb) of Gomez-Velez et al. (2015).</p></li>
<li><p><strong><span style="color:#009688">“kd_pred”</span></strong>: The predicted irradiance attenuation coefficient (<em>K<sub>d</sub></em>, m<em><sup>-1</sup></em>) for turbid water. Here, we predicted this based on the current turbidity using a log-log linear regression between <em>K<sub>d</sub></em> and turbidity that was derived from <em>in situ</em> measurements.</p></li>
<li><p><strong><span style="color:#009688">“PAR_inc”</span></strong>: Incoming, above the canopy, PAR (<span class="math inline">\(\mu\)</span>mol m<em><sup>-2</sup> s<sup>-1</sup></em>)</p></li>
<li><p><strong><span style="color:#009688">“veg_shade”</span></strong>: The proportion of the channel crossection that is shaded by riparian vegetation</p></li>
<li><p><strong><span style="color:#009688">“bank_shade”</span></strong>: The proportion of the channel crossection that is shaded by stream banks</p></li>
<li><p><strong><span style="color:#009688">“PAR_surface”</span></strong>: Estimated PAR at the stream surface (<span class="math inline">\(\mu\)</span>mol m<sup>-2</sup> s<sup>-1</sup>)</p></li>
<li><p><strong><span style="color:#009688">“PAR_subsurface”</span></strong>: Estimated PAR below the stream surface (<span class="math inline">\(\mu\)</span>mol m<sup>-2</sup> s<sup>-1</sup>)</p></li>
<li><p><strong><span style="color:#009688">“PAR_water”</span></strong>: Estimated PAR at the benthic surface assuming optically clear water (<span class="math inline">\(\mu\)</span>mol m<sup>-2</sup> s<sup>-1</sup>)</p></li>
<li><p><strong><span style="color:#009688">“kd_water”</span></strong>: Irradiance attenuation coefficient for optically clear water</p></li>
<li><p><strong><span style="color:#009688">“PAR_turb”</span></strong>: Estimated PAR at the benthic surface for turbid water (<span class="math inline">\(\mu\)</span>mol m<sup>-2</sup> s<sup>-1</sup>)</p></li>
<li>
<p><strong><span style="color:#009688">“kd_turb”</span></strong>: The irradiance attenuation coefficient for turbid water. This value is predicted based on the current turbidity using a log-log linear regression between Kd and turbidity that was derived from <em>in situ</em> measurements.</p>
<p>*Note, modeled predictions of PAR will have NA values when the sun is below the horizon.</p>
</li>
</ul>
</div>
<div id="appendix" class="section level2">
<h2 class="hasAnchor">
<a href="#appendix" class="anchor"></a>5. Appendix</h2>
<p>The <strong><span style="color:DarkOrange">aqua_light</span></strong> adds several proceses to the existing <strong><span style="color:DarkOrange">stream_light</span></strong> function including water surface reflection and attenuation as a function of depth and clarity. Therefore, only these new processes are documented below.</p>
<div id="water-surface-reflection" class="section level3">
<h3 class="hasAnchor">
<a href="#water-surface-reflection" class="anchor"></a>5.1 Water surface reflection</h3>
<p>The proportion of incident light reflected by the surface of the water (<span class="math inline">\(R_l\)</span>) was calculated following Kirk et al. (2011):</p>
<p><span class="math display">\[
\begin{align*}R_l = \frac{1}{2} *  \frac{sin^2(\theta_a - \theta_w)}{sin^2(\theta_a + \theta_w)} + \frac{1}{2} *\frac{tan^2(\theta_a - \theta_w)}{tan^2(\theta_a + \theta_w)}\\\end{align*}
\]</span></p>
<p>where <span class="math inline">\(\theta_a\)</span> is the solar zenith angle and <span class="math inline">\(\theta_w\)</span> is the angle of refraction within the water. <span class="math inline">\(\theta_w\)</span> was calculated following Snell’s law: <span class="math display">\[
\frac{sin \theta_a}{sin \theta_w}= \frac{n_w}{n_a}
\]</span> where <span class="math inline">\(n_w\)</span> is the refractive index for water and <span class="math inline">\(n_a\)</span> is the refractive index of water. Air and water have different refractive properties but a value of 1.33 for the ratio of the refractive indices of air to water is a good approximation for freshwater and the wavelengths of light within photosynthetically active radiation (PAR) (Kirk et al, 2011): <span class="math display">\[
\frac{n_w}{n_a} = 1.33
\]</span></p>
</div>
<div id="water-column-light-extinction" class="section level3">
<h3 class="hasAnchor">
<a href="#water-column-light-extinction" class="anchor"></a>5.2 Water column light extinction</h3>
<p>Within the water column light attenuates nonlinearly with depth which can be described using a Beer-Lambert equation: <span class="math display">\[
I_z = I_{sub}e^{-{K_d}*z}
\]</span> where light at a given depth (<span class="math inline">\(I_z\)</span>) can be calculated using light just below the water surface (<span class="math inline">\(I_{sub}\)</span>), depth (<span class="math inline">\(z\)</span>), and the extinction coefficient (<span class="math inline">\(K_d\)</span>).</p>
</div>
<div id="appendix-references" class="section level3">
<h3 class="hasAnchor">
<a href="#appendix-references" class="anchor"></a>Appendix References</h3>
<p>Kirk, J. T. O. (2011). Light and photosynthesis in aquatic ecosystems (3rd ed.). Cambridge, UK 455 and New York: Cambridge University Press.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Phil Savoy.</p>
</div>

<div class="pkgdown">
  <p>Made with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1, using <a href="https://preferably.amirmasoudabdol.name/?source=footer">preferably</a> template.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
